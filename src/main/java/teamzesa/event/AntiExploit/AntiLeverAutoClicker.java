package teamzesa.event.AntiExploit;

import org.bukkit.Material;
import org.bukkit.block.Block;
import org.bukkit.event.block.Action;
import org.bukkit.event.player.PlayerInteractEvent;
import teamzesa.entity.User;
import teamzesa.event.register.EventRegister;
import teamzesa.util.ComponentExchanger;
import teamzesa.util.userHandler.UserController;

public class AntiLeverAutoClicker extends ComponentExchanger implements EventRegister {
    private User user;
    private Action action;
    private Block clickedBlock;
    private LeverActionStatus leverActionStatus;
    private final PlayerInteractEvent event;

    public AntiLeverAutoClicker(PlayerInteractEvent event) {
        this.event = event;
        init();
        execute();
    }

    @Override
    public void init() {
        this.user = new UserController().readUser(this.event.getPlayer());
        this.action = this.event.getAction();
        this.clickedBlock = this.event.getClickedBlock();
        this.leverActionStatus = LeverActionStatus.getLeverActionStatus();
    }

    @Override
    public void execute() {
        System.out.println();
        System.out.println("1");
//        클릭블럭 체크
        if (this.clickedBlock == null) return;

        System.out.println("2");
//        블럭타입체크 * 로직상 우선되어야 더빠른 처리
        if (this.clickedBlock.getType() != Material.LEVER) return;

        System.out.println("3");
//        우클릭인지 확인
        if (!(this.action.isRightClick())) return;

//        현재 레버 작용이 허용되었는지
        System.out.println("4");
        if (this.leverActionStatus.isActionLever(this.user)) {
//            작동이 허용됐다면 정상 이벤트 발생
            this.leverActionStatus.removeStatus(this.user);
        }

//        안됐을시, 유저가 status 에 존재하는지 확인
        System.out.println("5");
        if (this.leverActionStatus.userExist(this.user))
            return; // 존재한다면, 대기시키도록 반환

//        유저가 존재하지 않는다면
        System.out.println("6");
        this.leverActionStatus.addLeverActionEvent(this.user, System.currentTimeMillis());
    }
}
